<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Mapping Water Points</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet'/>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    #instructions {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 50px;
      bottom: 820px;
      overflow-y: scroll;
      background-color: white ;
      opacity: 0.92;
      padding: 5px 20px 5px 20px;
      border-radius: 10px;
      font-family: Montserrat, sans-serif;
      color: black;
    }
    a {
    text-decoration: underline;
    color: #63AFAE;
}

  </style>
</head>

<body>
  <div id="map"></div>
  <div id="instructions">
    <h1>ðŸš° Water Spots in the Zaatari Refugee Camp!</h1>
    <h2> Background</h2>
    <p> The SPHERE standards which mandates standards for humanitarian action state that residents of a refugee camp should travel less than 500 meters to access water. This interactive map shows that no matter where a resident resides in the Zaatari Refugee Camp in Jordan they are within 500 meters of a water spot, meeting SPHERE Standards. Check it out yourself by following the simple instructions below. To learn more about SPHERE Sandards related to water, check out the SPHERE Handbook Chapter on Water <a href="https://handbook.spherestandards.org/en/sphere/#ch006_004">here</a>. As the data changes you may want to update it, if you wish to do so follow this <a href="https://github.com/kpecsok98/studio-week5/blob/main/data-tutorial/DATA-TUTORIAL.md">tutorial</a> on collecting and filtering this data, and if you wish to code the data click on this <a href="https://github.com/kpecsok98/studio-week5">link</a> which provides a reference of the code used to present the data on this webpage.</p>
    <h2> Instructions</h2>
    <p>Click anywhere on the map to see water sites within a 500m radius at the Zaatari Refugee Camp. Stand alone water sites within the 500 meter radius will be highlighted in red when you click on the map.</p>
  </div>
  <script>
    // Data showing water points - replace the dummy URL with your own.
    var url = 'https://raw.githubusercontent.com/kpecsok98/studio-week5/main/data-tutorial/data/zaatari_refugeecamp_water_kpecsok_simplified.geojson'


    mapboxgl.accessToken = 'pk.eyJ1Ijoia3BlY3Nvazk4IiwiYSI6ImNrbGp0Zml4aTA5bjEydWtieXBoanpkMTAifQ.8gD5--vW98H28Jp_HcwUmg';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-v9', // imagery basemap - you may choose something else
      center: [36.3295, 32.2963], // starting position at Zaatari Camp
      zoom: 14, // starting zoom
    });

    map.on('load', function () {

      // Map layers go here!
      map.addLayer({
        id: 'OSM-water',
        source: {
          type: 'geojson',
          data: url
        },
        type: 'circle',
        paint: {
          'circle-color': '#83e8fc',
          'circle-radius': 3,
          'circle-opacity': 1,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#0557fa',
        }
      });



      // When the map has finished loading, add a new layer that will be empty
      // at first, but will eventually house our confirmed water sites.
      map.addLayer({
        id: 'selected-water',
        source: {
          type: 'geojson',
          data: { "type": "FeatureCollection", "features": [] }
        },
        type: 'circle',
        paint: {
          'circle-color': 'red',
          'circle-radius': 3
        }
      });



      // Draw the search radius on the map
      map.addLayer({
        id: 'search-radius',
        source: {
          type: 'geojson',
          data: { "type": "FeatureCollection", "features": [] }
        },
        type: 'fill',
        paint: {
          'fill-color': '#fcf683',
          'fill-opacity': 0.5
        }
      });


    //Click event goes here!
    map.on('click', function(e) {
      var eventLngLat = [e.lngLat.lng, e.lngLat.lat];
      var searchRadius = makeRadius(eventLngLat, 500);
      map.getSource('search-radius').setData(searchRadius);
      var featuresInBuffer = spatialJoin('OSM-water', searchRadius);
      map.getSource('selected-water').setData(turf.featureCollection(featuresInBuffer));
      /*console.log(eventLngLat)*/
    });

  });
    //makeRadius function goes here!
      function makeRadius(lngLatArray, radiusInMeters) {
        var point = turf.point(lngLatArray);
        var buffered = turf.buffer(point, radiusInMeters, { units: 'meters' });
        return buffered;
      }

    //spatialJoin function goes here!
    function spatialJoin(sourceLayer, filterFeature) {
      // Need this line to specify the array since map.getSource in the click event doesn't do this.
      sourceGeoJSON = map.querySourceFeatures(sourceLayer);
      // Loop through all the features in the source geojson and return the ones that
      // are inside the filter feature (buffered radius) and are confirmed free standing sites
      var joined = sourceGeoJSON.filter(function (feature) {
        return turf.booleanPointInPolygon(feature, filterFeature) && feature.properties.type === 'Free_standing';
      });

      return joined;
    };


  </script>

</body>

</html>
